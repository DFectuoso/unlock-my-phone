{% extends 'base.html' %}
{% block content %}

<section class="group" id="venue_list" data-hunt-id="{{hunt.key}}">
  <header>
    <p class="desc">Your Hunt</p>
    <h2>{{hunt.name}}</h2>
  </header>
  <h3>Checkpoints</h3>
  <ul id="current_venues">
    {% for venue in venues %}
       <li class="venue-item" data-id="{{venue.foursquare_id}}"><a class="close" href="#">&times;</a>{{venue.name}}</li>
    {% endfor %}
  </ul>
  <h3>Add a new checkpoint</h3>
  <form method="get" class="" id="venue_form">
    <div class="clearfix">
      <label>Type a venue</label>
      <input type="text" name="query" placeholder="Pizza" id="venue_query" />
    </div>
  </form>
  <div id="venue_map">
    
  </div>
</section>


{% endblock %}
{% block javascript %}
<script src="/static/js/bootstrap-alerts.js" type="text/javascript"></script>
<script type="text/javascript">

if (Modernizr.geolocation) {
  navigator.geolocation.getCurrentPosition(function(location) {
    $('#venue_list')
      .data('ll', location.coords.latitude + "," + location.coords.longitude)
      .data('ll_act', location.coords.accuracy)
      .data('alt', location.coords.altitude + 0)
      .data('alt_acc', location.coords.altitudeAcc);
  });
}

$(function(){
  
  var $vl = $('#venue_list');
    
  var send_query = function(query_word) {
      var sent_data = {
          ll: $vl.data('ll'),
          ll_act: $vl.data('ll_act'),
          alt: $vl.data('alt'),
          alt_acc: $vl.data('alt_acc'),
          query: query_word
        };
      $.ajax({
          url:        "/venue/search",
          dataType:   "json", 
          data:       sent_data, 
          success:    function(data) {
                      var venues = data.response.groups[0].items;
                                  if (venues.length === 0) {
                        $list = '<p>No venues found.</p>';
                      } else {
                        $list = $('<ul/>');
                        for (i in venues) {
                          if (!!venues[i]) {
                            $list.append('<li><a href="#" data-id="'+venues[i].id+'" class="add_venue">'+venues[i].name+'</a></li>');
                          }
                        }          
                      }

          
                      $('#venue_map').empty().append($list);
                    }
      });
    };
  
  var delay = (function(){
    var timer = 0;
    return function(callback, ms){
      clearTimeout (timer);
      timer = setTimeout(callback, ms);
    };
  })();
  
  $('#venue_query').keyup(function() {
    $el = $(this); 
    delay(function() {
      send_query($el.val());
    }, 300);
  });

  $('#venue_map').delegate('a.add_venue', 'click', function(e) {
    e.preventDefault();
    var $el = $(this),
      venue_id = $el.data('id'),
      hunt_id = $('#venue_list').data('hunt-id');
    $.get('/hunt/'+hunt_id+'/add_venue?venue_id=' + venue_id , function(data) {
      if (data === 'Ok') {
        $('#current_venues')
          .append('<li class="venue-item" data-id="'+venue_id+'"><a class="close" href="#">&times;</a>'+$el.text()+'</li>');
        $('<div class="alert-message success"><a class="close" href="#">&times;</a><p>Venue added succesfully</p></div>').appendTo('#alerts');
      } else if (data === "Error") {
        console.log('todo mal');
      } else {
        console.log('todo muy mal');
      }
    });
  });
  
  $('#current_venues').delegate('a.close', 'click', function(e) {
    $el = $(this).closest('.venue-item'),
      venue_id = $el.data('id'),
      hunt_id = $('#venue_list').data('hunt-id');
    
    $.get('/hunt/'+hunt_id+'/remove_venue?venue_id=' + venue_id, function(data) {
      if (data === 'Ok') {
        $el.remove();
        $('<div class="alert-message success"><a class="close" href="#">&times;</a><p>Venue removed succesfully</p></div>').appendTo('#alerts');
      } else if (data === "Error") {
        console.log('todo mal');
      } else {
        console.log('todo muy mal');
      }
    })
  });
  
  $("#alerts .alert-message").alert();
});


</script>
{% endblock %}
